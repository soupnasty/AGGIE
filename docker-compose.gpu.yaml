# AGGIE Voice Assistant - GPU-Enabled Docker Compose
#
# Prerequisites:
#   1. NVIDIA GPU with CUDA support
#   2. nvidia-container-toolkit: https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/install-guide.html
#   3. Copy .env.example to .env and set ANTHROPIC_API_KEY
#
# Build & Run:
#   docker compose -f docker-compose.gpu.yaml build
#   docker compose -f docker-compose.gpu.yaml up
#
# Verify GPU:
#   docker compose -f docker-compose.gpu.yaml exec aggie aggie-ctl status
#   # Should show: GPU: NVIDIA GeForce GTX 1060 (6.0GB)

services:
  aggie:
    build:
      context: .
      dockerfile: Dockerfile.gpu
    image: aggie:gpu
    container_name: aggie-gpu
    restart: unless-stopped

    # GPU access
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - PULSE_SERVER=unix:/run/user/1000/pulse/native
      - NVIDIA_VISIBLE_DEVICES=all

    devices:
      - /dev/snd:/dev/snd

    volumes:
      - ${XDG_RUNTIME_DIR:-/run/user/1000}/pulse:/run/user/1000/pulse:ro
      - aggie-cache:/home/aggie/.cache
      - aggie-models:/home/aggie/.local/share

    group_add:
      - audio

volumes:
  aggie-cache:
    name: aggie-gpu-cache
  aggie-models:
    name: aggie-gpu-models
